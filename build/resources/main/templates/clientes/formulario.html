<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Formulario de Cliente</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
            .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        50% { transform: rotate(180deg); }
        100% { transform: rotate(360deg); }
    }
        .container {
            margin-top: 20px;
        }
        .col-md-6 {
            padding: 10px;
        }
        .table {
            margin-top: 20px;
        }
    </style>
        <script>
            
            async function actualizarCliente() {
            const dni = document.getElementById("dni").value;
            const apellido = document.getElementById("apellido").value;
            const nombre = document.getElementById("nombre").value;
            const antecedentes = document.getElementById("antecedentes").value;

            if (!dni) {
                alert("Debe buscar un cliente antes de actualizar.");
                return;
            }

    const cliente = {
        dni: dni,
        apellido: apellido,
        nombre: nombre,
        antecedentes: antecedentes
    };

    try {
        const response = await fetch('/clientes/actualizar', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cliente)
        });

        if (response.ok) {
            alert("Cliente actualizado correctamente.");
        } else {
            alert("Error al actualizar el cliente.");
        }
    } catch (error) {
        console.error("Error al realizar la solicitud PUT:", error);
        alert("Error al actualizar el cliente.");
    }
}

            
            function limpiarFormulario() {
    // Recargar la página actual
            window.location.reload();
            }
            
            async function verificarDni() {
                const dni = document.getElementById("dni").value;
                const loadingIndicator = document.getElementById("loadingIndicator");
                if (!dni) {
                    alert("Por favor, ingrese un DNI válido.");
                    return;
                }

                try {
                     loadingIndicator.style.display = "inline";
                    // Consultar al backend para obtener el cliente
                    const clienteResponse = await fetch(`/clientes/buscar?dni=${dni}`);
                    if (clienteResponse.ok) {
                        const cliente = await clienteResponse.json();
                        document.getElementById("nombre").value = cliente.nombre || "";
                        document.getElementById("apellido").value = cliente.apellido || "";
                        document.getElementById("antecedentes").value = cliente.antecedentes || "";
                        
                        document.getElementById("nombre").disabled = false;
                        document.getElementById("apellido").disabled = false;
                        document.getElementById("antecedentes").disabled = false;
                        document.getElementById("dni").disabled = true;
                        const submitButton = document.getElementById("submitButton");
                        submitButton.textContent = "Actualizar";
                        
                    } else {
                        alert("Cliente no encontrado.");
                        return;
                    }

                    // Consultar al backend para obtener las historias clínicas
                    const historyResponse = await fetch(`/history/${dni}`);
                    const processes = await historyResponse.json();

                    // Mostrar procesos
// Obtener el cuerpo de la tabla
const processTableBody = document.querySelector("#processTable tbody");

// Limpiar la tabla por si hay datos previos
processTableBody.innerHTML = "";

// Procesar cada proceso y sus elementos
processes.forEach((process, index) => {
    const components = [
        { tipo: "Historia Clínica", data: process.historia },
        { tipo: "Demanda", data: process.demanda },
        { tipo: "Estudios Perito", data: process.estudios },
        { tipo: "Pericia", data: process.pericia }
    ];

    components.forEach(component => {
        if (component.data) {
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>${component.tipo}</td>
                <td>${component.data.fecha}</td>
                <td>${component.data.fechaCarga}</td>
            `;

            processTableBody.appendChild(row);
        }
    });
});

                } catch (error) {
                    console.error("Error al consultar el backend:", error);
                } finally {
        // Ocultar el indicador de carga
        loadingIndicator.style.display = "none";
    }
            }
        </script>
    </head>
    <body>
        
        
<div class="container">
    <div class="row">
        <!-- Panel Izquierdo: Información del Cliente -->
        <div class="col-md-6">
            <h1>Registrar Cliente</h1>
            <form th:action="@{/clientes/guardar}" th:object="${cliente}" method="post">
                <div>
                    <label for="dni">DNI:</label>
                    <input type="text" id="dni" th:field="*{dni}" placeholder="Ingrese el DNI" required />
                    <button type="button" onclick="verificarDni()">Buscar</button>
                    <div id="loadingIndicator" class="spinner" style="display: none;"></div>
                </div>
                <div>
                    <label for="apellido">Apellido:</label>
                    <input type="text" id="apellido" th:field="*{apellido}" placeholder="Ingrese el apellido" required  />
                </div>
                <div>
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" th:field="*{nombre}" placeholder="Ingrese el nombre"  />
                </div>
                <div>
                    <label for="antecedentes">Antecedentes:</label>
                    <input type="text" id="antecedentes" th:field="*{antecedentes}" placeholder="Ingrese antecedentes"  />
                </div>
                <div>
                    <button type="submit" id="submitButton" >Guardar</button>
                </div>
                <div>
                    <button type="button" onclick="limpiarFormulario()">Limpiar</button>
                </div>
            </form>
        </div>

        <!-- Panel Derecho: Lista de Procesos -->
        <div class="col-md-6">
            <div id="processList">
                <h3>Procesos:</h3>
                <table id="processTable" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Fecha Siniestro</th>
                            <th>Fecha Carga</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las filas se generarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        <a href="/">
            <img src="https://img.icons8.com/ios-filled/50/000000/home.png" alt="Home" class="home-icon" title="Volver a Inicio">
        </a>
    </body>
</html>
